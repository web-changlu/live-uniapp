<template>
	<view class="page-container">
		<!-- ç›´æ’­è§†é¢‘åŒºåŸŸ -->
		<view class="video-container">
			<!-- æœ¬åœ°è§†é¢‘é¢„è§ˆ -->
			<view v-if="isAnchor" class="local-video">
				<!-- TRTCçš„æœ¬åœ°è§†é¢‘é¢„è§ˆç»„ä»¶ -->
				<trtc-local-view v-if="trtcStore.localStream.videoEnabled" class="video-view" :viewId="localViewId"></trtc-local-view>
				<view v-else class="placeholder-video">
					<text class="placeholder-text">æ‘„åƒå¤´å·²å…³é—­</text>
				</view>
			</view>

			<!-- è¿œç¨‹è§†é¢‘ -->
			<view v-else class="remote-video">
				<!-- TRTCçš„è¿œç¨‹è§†é¢‘é¢„è§ˆç»„ä»¶ -->
				<trtc-remote-view v-if="hasRemoteStream" class="video-view" :viewId="remoteViewId" :userId="liveStore.anchor.id"></trtc-remote-view>
				<view v-else class="placeholder-video">
					<text class="placeholder-text">ç­‰å¾…ä¸»æ’­å¼€æ’­...</text>
				</view>
			</view>

			<!-- ç›´æ’­ä¿¡æ¯ -->
			<view class="live-info">
				<view class="anchor-info">
					<image class="anchor-avatar" :src="liveStore.anchor.avatar || '/static/images/default-avatar.png'" />
					<text class="anchor-name">{{ liveStore.anchor.name }}</text>
					<view class="viewer-count">
						<text class="viewer-count-text">{{ liveStore.stats.viewerCount }}</text>
					</view>
				</view>
				<text class="live-title">{{ liveStore.liveInfo.title }}</text>
			</view>

			<!-- è§†é¢‘æ§åˆ¶æŒ‰é’® -->
			<view v-if="isAnchor" class="video-controls">
				<view class="control-button" @click="toggleVideo">
					<text class="control-icon">{{ trtcStore.localStream.videoEnabled ? 'ğŸ“¹' : 'ğŸš«' }}</text>
					<text class="control-text">{{ trtcStore.localStream.videoEnabled ? 'å…³é—­æ‘„åƒå¤´' : 'å¼€å¯æ‘„åƒå¤´' }}</text>
				</view>
				<view class="control-button" @click="toggleAudio">
					<text class="control-icon">{{ trtcStore.localStream.audioEnabled ? 'ğŸ¤' : 'ğŸ”‡' }}</text>
					<text class="control-text">{{ trtcStore.localStream.audioEnabled ? 'å…³é—­éº¦å…‹é£' : 'å¼€å¯éº¦å…‹é£' }}</text>
				</view>
				<view class="control-button" @click="switchCamera">
					<text class="control-icon">ğŸ”„</text>
					<text class="control-text">åˆ‡æ¢æ‘„åƒå¤´</text>
				</view>
			</view>
		</view>

		<!-- äº’åŠ¨åŒºåŸŸ -->
		<view class="interaction-container">
			<!-- æ¶ˆæ¯åˆ—è¡¨ -->
			<scroll-view class="message-list" scroll-y="true" :scroll-into-view="lastMessageId">
				<view v-for="(message, index) in liveStore.messages" :key="message.id" :id="message.id" class="message-item">
					<text class="message-sender">{{ message.userName }}:</text>
					<text class="message-content">{{ message.content }}</text>
				</view>
			</scroll-view>

			<!-- è¾“å…¥åŒºåŸŸ -->
			<view class="input-area">
				<input class="message-input" v-model="messageContent" placeholder="è¯´ç‚¹ä»€ä¹ˆ..." @confirm="sendMessage" />
				<button class="send-button" @click="sendMessage">å‘é€</button>
			</view>

			<!-- æ“ä½œæŒ‰é’® -->
			<view class="action-buttons">
				<view class="action-button" @click="handleLike">
					<text class="action-icon">ğŸ‘</text>
					<text class="action-text">{{ liveStore.stats.likeCount }}</text>
				</view>
				<view class="action-button" @click="handleShare">
					<text class="action-icon">ğŸ“¤</text>
					<text class="action-text">åˆ†äº«</text>
				</view>
				<view class="action-button" @click="handleGift">
					<text class="action-icon">ğŸ</text>
					<text class="action-text">ç¤¼ç‰©</text>
				</view>
				<view v-if="isAnchor" class="action-button end-live" @click="endLive">
					<text class="action-text">ç»“æŸç›´æ’­</text>
				</view>
				<view v-else class="action-button leave-room" @click="leaveRoom">
					<text class="action-text">ç¦»å¼€</text>
				</view>
			</view>
		</view>
	</view>
</template>

<script setup>
import { ref, computed, onMounted, onUnmounted } from 'vue';
import { useLiveStore } from '@/store/modules/live';
import { useUserStore } from '@/store/modules/user';
import { useTrtcStore } from '@/store/modules/trtc';

// ä½¿ç”¨store
const liveStore = useLiveStore();
const userStore = useUserStore();
const trtcStore = useTrtcStore();

// é¡µé¢å‚æ•°
const roomId = ref('');
const messageContent = ref('');
const lastMessageId = ref('');

// è§†é¢‘è§†å›¾ID
const localViewId = ref('local-video-view');
const remoteViewId = ref('remote-video-view');

// è®¡ç®—å±æ€§
const isAnchor = computed(() => {
	return userStore.userId === liveStore.anchor.id;
});

const hasRemoteStream = computed(() => {
	return trtcStore.remoteStreams.length > 0;
});

// è§†é¢‘æ§åˆ¶æ–¹æ³•
const toggleVideo = async () => {
	const enabled = !trtcStore.localStream.videoEnabled;
	await trtcStore.toggleLocalVideo(enabled);

	if (enabled && !trtcStore.localStream.videoView) {
		// å¦‚æœå¼€å¯è§†é¢‘ä¸”æ²¡æœ‰è§†å›¾ï¼Œåˆ™å¯åŠ¨æœ¬åœ°é¢„è§ˆ
		await trtcStore.startLocalPreview(localViewId.value);
	}
};

const toggleAudio = async () => {
	await trtcStore.toggleLocalAudio(!trtcStore.localStream.audioEnabled);
};

const switchCamera = async () => {
	// ç›´æ¥è°ƒç”¨trtcStoreçš„switchCameraæ–¹æ³•
	await trtcStore.switchCamera();

	// æ˜¾ç¤ºåˆ‡æ¢æç¤º
	uni.showToast({
		title: trtcStore.currentDevices.isFrontCamera ? 'å·²åˆ‡æ¢åˆ°å‰ç½®æ‘„åƒå¤´' : 'å·²åˆ‡æ¢åˆ°åç½®æ‘„åƒå¤´',
		icon: 'none',
		duration: 1500
	});
};

// å‘é€æ¶ˆæ¯
const sendMessage = () => {
	if (!messageContent.value.trim()) return;

	const message = liveStore.sendMessage({
		userId: userStore.userId,
		userName: userStore.userName,
		userAvatar: userStore.userAvatar,
		content: messageContent.value,
		type: 'text'
	});

	// æ¸…ç©ºè¾“å…¥æ¡†
	messageContent.value = '';

	// è®¾ç½®æœ€åä¸€æ¡æ¶ˆæ¯IDï¼Œç”¨äºæ»šåŠ¨åˆ°åº•éƒ¨
	lastMessageId.value = message.id;
};

// ç‚¹èµ
const handleLike = () => {
	liveStore.addLike();
};

// åˆ†äº«
const handleShare = () => {
	uni.showActionSheet({
		itemList: ['åˆ†äº«åˆ°å¾®ä¿¡', 'åˆ†äº«åˆ°æœ‹å‹åœˆ', 'å¤åˆ¶é“¾æ¥'],
		success: (res) => {
			liveStore.addShare();
			uni.showToast({
				title: 'åˆ†äº«æˆåŠŸ',
				icon: 'success'
			});
		}
	});
};

// ç¤¼ç‰©
const handleGift = () => {
	uni.showActionSheet({
		itemList: ['é²œèŠ± (10å¸)', 'æŒå£° (50å¸)', 'ç«ç®­ (100å¸)'],
		success: (res) => {
			let giftInfo = {};

			switch (res.tapIndex) {
				case 0:
					giftInfo = {
						giftId: 'gift_flower',
						giftName: 'é²œèŠ±',
						giftImage: '/static/images/gift-flower.png',
						giftValue: 10
					};
					break;
				case 1:
					giftInfo = {
						giftId: 'gift_applause',
						giftName: 'æŒå£°',
						giftImage: '/static/images/gift-applause.png',
						giftValue: 50
					};
					break;
				case 2:
					giftInfo = {
						giftId: 'gift_rocket',
						giftName: 'ç«ç®­',
						giftImage: '/static/images/gift-rocket.png',
						giftValue: 100
					};
					break;
			}

			liveStore.sendGift({
				userId: userStore.userId,
				userName: userStore.userName,
				userAvatar: userStore.userAvatar,
				...giftInfo
			});

			uni.showToast({
				title: 'èµ é€æˆåŠŸ',
				icon: 'success'
			});
		}
	});
};

// ç»“æŸç›´æ’­ï¼ˆä¸»æ’­ï¼‰
const endLive = async () => {
	uni.showModal({
		title: 'ç»“æŸç›´æ’­',
		content: 'ç¡®å®šè¦ç»“æŸå½“å‰ç›´æ’­å—ï¼Ÿ',
		success: async (res) => {
			if (res.confirm) {
				// æ˜¾ç¤ºåŠ è½½ä¸­
				uni.showLoading({
					title: 'ç»“æŸç›´æ’­ä¸­...'
				});

				try {
					// åœæ­¢æœ¬åœ°é¢„è§ˆ
					await trtcStore.stopLocalPreview();

					// ç»“æŸç›´æ’­
					await liveStore.endLive();

					// ç¦»å¼€TRTCæˆ¿é—´
					await trtcStore.leaveRoom();

					// é”€æ¯TRTC
					await trtcStore.destroyTrtc();

					// éšè—åŠ è½½ä¸­
					uni.hideLoading();

					// è¿”å›ä¸Šä¸€é¡µ
					uni.navigateBack();
				} catch (error) {
					// éšè—åŠ è½½ä¸­
					uni.hideLoading();

					// æ˜¾ç¤ºé”™è¯¯æç¤º
					uni.showToast({
						title: error.message || 'ç»“æŸç›´æ’­å¤±è´¥',
						icon: 'none'
					});
				}
			}
		}
	});
};

// ç¦»å¼€æˆ¿é—´ï¼ˆè§‚ä¼—ï¼‰
const leaveRoom = async () => {
	// æ˜¾ç¤ºåŠ è½½ä¸­
	uni.showLoading({
		title: 'ç¦»å¼€æˆ¿é—´ä¸­...'
	});

	try {
		// ç¦»å¼€ç›´æ’­é—´
		await liveStore.leaveLiveRoom(userStore.userId);

		// ç¦»å¼€TRTCæˆ¿é—´
		await trtcStore.leaveRoom();

		// é”€æ¯TRTC
		await trtcStore.destroyTrtc();

		// éšè—åŠ è½½ä¸­
		uni.hideLoading();

		// è¿”å›ä¸Šä¸€é¡µ
		uni.navigateBack();
	} catch (error) {
		// éšè—åŠ è½½ä¸­
		uni.hideLoading();

		// æ˜¾ç¤ºé”™è¯¯æç¤º
		uni.showToast({
			title: error.message || 'ç¦»å¼€æˆ¿é—´å¤±è´¥',
			icon: 'none'
		});
	}
};

// åˆå§‹åŒ–æœ¬åœ°é¢„è§ˆï¼ˆä¸»æ’­ï¼‰
const initLocalPreview = async () => {
	if (isAnchor.value) {
		try {
			// å¯åŠ¨æœ¬åœ°é¢„è§ˆ
			await trtcStore.startLocalPreview(localViewId.value);
		} catch (error) {
			uni.showToast({
				title: error.message || 'å¯åŠ¨æœ¬åœ°é¢„è§ˆå¤±è´¥',
				icon: 'none'
			});
		}
	}
};

// åŠ å…¥æˆ¿é—´
const joinRoom = async () => {
	if (!roomId.value) return;

	// æ˜¾ç¤ºåŠ è½½ä¸­
	uni.showLoading({
		title: 'åŠ å…¥æˆ¿é—´ä¸­...'
	});

	try {
		// åˆå§‹åŒ–TRTC
		await trtcStore.initTrtc();

		// åŠ å…¥ç›´æ’­é—´
		await liveStore.joinLiveRoom(roomId.value, {
			userId: userStore.userId,
			userName: userStore.userName,
			userAvatar: userStore.userAvatar
		});

		// åŠ å…¥TRTCæˆ¿é—´
		await trtcStore.joinRoom({
			roomId: roomId.value,
			userId: userStore.userId,
			userSig: userStore.userInfo.userSig,
			sdkAppId: userStore.userInfo.sdkAppId,
			role: 'audience' // ä½œä¸ºè§‚ä¼—åŠ å…¥
		});

		// éšè—åŠ è½½ä¸­
		uni.hideLoading();
	} catch (error) {
		// éšè—åŠ è½½ä¸­
		uni.hideLoading();

		// æ˜¾ç¤ºé”™è¯¯æç¤º
		uni.showToast({
			title: error.message || 'åŠ å…¥æˆ¿é—´å¤±è´¥',
			icon: 'none'
		});

		// è¿”å›ä¸Šä¸€é¡µ
		uni.navigateBack();
	}
};

onMounted(() => {
	// è·å–é¡µé¢å‚æ•°
	const query = uni.getEnterOptionsSync().query;

	if (query && query.roomId) {
		roomId.value = query.roomId;

		// å¦‚æœæ˜¯ä¸»æ’­ï¼Œåˆå§‹åŒ–æœ¬åœ°é¢„è§ˆ
		if (userStore.userId === liveStore.anchor.id) {
			initLocalPreview();
		} else {
			// å¦‚æœæ˜¯è§‚ä¼—ï¼ŒåŠ å…¥æˆ¿é—´
			joinRoom();
		}
	} else {
		uni.showToast({
			title: 'æˆ¿é—´IDä¸å­˜åœ¨',
			icon: 'none'
		});
		uni.navigateBack();
	}
});

onUnmounted(() => {
	// å¦‚æœæ˜¯ä¸»æ’­ï¼Œåœæ­¢æœ¬åœ°é¢„è§ˆ
	if (isAnchor.value) {
		trtcStore.stopLocalPreview();
	}

	// å¦‚æœæ˜¯ä¸»æ’­ï¼Œç»“æŸç›´æ’­
	if (isAnchor.value && liveStore.liveStatus === 'live') {
		liveStore.endLive();
	}

	// å¦‚æœæ˜¯è§‚ä¼—ï¼Œç¦»å¼€ç›´æ’­é—´
	if (!isAnchor.value) {
		liveStore.leaveLiveRoom(userStore.userId);
	}

	// ç¦»å¼€TRTCæˆ¿é—´
	trtcStore.leaveRoom();

	// é”€æ¯TRTC
	trtcStore.destroyTrtc();
});
</script>

<style>
/* é¡µé¢å®¹å™¨ */
.page-container {
	flex: 1;
	flex-direction: column;
	background-color: #1a1a1a;
	width: 750rpx;
	height: 100vh;
}

/* è§†é¢‘å®¹å™¨ */
.video-container {
	position: relative;
	width: 750rpx;
	height: 60vh;
	background-color: #000000;
}

/* æœ¬åœ°è§†é¢‘å’Œè¿œç¨‹è§†é¢‘ */
.local-video, .remote-video {
	width: 750rpx;
	height: 60vh;
}

/* è§†é¢‘è§†å›¾ */
.video-view {
	width: 750rpx;
	height: 60vh;
}

/* å ä½è§†é¢‘ */
.placeholder-video {
	width: 750rpx;
	height: 60vh;
	justify-content: center;
	align-items: center;
	background-color: #333333;
}

/* å ä½æ–‡æœ¬ */
.placeholder-text {
	color: #ffffff;
	font-size: 32rpx;
}

/* ç›´æ’­ä¿¡æ¯ */
.live-info {
	position: absolute;
	top: 30rpx;
	left: 30rpx;
	right: 30rpx;
	flex-direction: column;
}

/* ä¸»æ’­ä¿¡æ¯ */
.anchor-info {
	flex-direction: row;
	align-items: center;
	margin-bottom: 10rpx;
}

/* ä¸»æ’­å¤´åƒ */
.anchor-avatar {
	width: 80rpx;
	height: 80rpx;
	border-radius: 40rpx;
	margin-right: 20rpx;
	border: 2rpx solid #ffffff;
}

/* ä¸»æ’­åç§° */
.anchor-name {
	color: #ffffff;
	font-size: 32rpx;
	font-weight: bold;
	margin-right: 20rpx;
}

/* è§‚ä¼—æ•°é‡ */
.viewer-count {
	background-color: rgba(0, 0, 0, 0.5);
	border-radius: 30rpx;
	padding: 5rpx 20rpx;
}

/* è§‚ä¼—æ•°é‡æ–‡æœ¬ */
.viewer-count-text {
	color: #ffffff;
	font-size: 24rpx;
}

/* ç›´æ’­æ ‡é¢˜ */
.live-title {
	color: #ffffff;
	font-size: 28rpx;
	margin-top: 10rpx;
}

/* è§†é¢‘æ§åˆ¶æŒ‰é’® */
.video-controls {
	position: absolute;
	bottom: 30rpx;
	left: 30rpx;
	right: 30rpx;
	flex-direction: row;
	justify-content: space-around;
}

/* æ§åˆ¶æŒ‰é’® */
.control-button {
	background-color: rgba(0, 0, 0, 0.5);
	border-radius: 10rpx;
	padding: 10rpx 20rpx;
	flex-direction: column;
	align-items: center;
}

/* æ§åˆ¶å›¾æ ‡ */
.control-icon {
	font-size: 40rpx;
	margin-bottom: 5rpx;
}

/* æ§åˆ¶æ–‡æœ¬ */
.control-text {
	color: #ffffff;
	font-size: 24rpx;
}

/* äº’åŠ¨å®¹å™¨ */
.interaction-container {
	flex: 1;
	flex-direction: column;
	padding: 20rpx;
	background-color: #1a1a1a;
}

/* æ¶ˆæ¯åˆ—è¡¨ */
.message-list {
	flex: 1;
	height: 25vh;
	margin-bottom: 20rpx;
}

/* æ¶ˆæ¯é¡¹ */
.message-item {
	flex-direction: row;
	margin-bottom: 15rpx;
	flex-wrap: wrap;
}

/* æ¶ˆæ¯å‘é€è€… */
.message-sender {
	color: #ffcc00;
	font-size: 28rpx;
	margin-right: 10rpx;
}

/* æ¶ˆæ¯å†…å®¹ */
.message-content {
	color: #ffffff;
	font-size: 28rpx;
	flex: 1;
}

/* è¾“å…¥åŒºåŸŸ */
.input-area {
	flex-direction: row;
	align-items: center;
	margin-bottom: 20rpx;
}

/* æ¶ˆæ¯è¾“å…¥æ¡† */
.message-input {
	flex: 1;
	background-color: #333333;
	border-radius: 40rpx;
	padding: 15rpx 30rpx;
	color: #ffffff;
	font-size: 28rpx;
	margin-right: 20rpx;
	height: 80rpx;
}

/* å‘é€æŒ‰é’® */
.send-button {
	background-color: #007aff;
	color: #ffffff;
	border-radius: 40rpx;
	width: 120rpx;
	height: 80rpx;
	line-height: 80rpx;
	text-align: center;
	font-size: 28rpx;
}

/* æ“ä½œæŒ‰é’® */
.action-buttons {
	flex-direction: row;
	justify-content: space-around;
	padding: 20rpx 0;
}

/* æ“ä½œæŒ‰é’®é¡¹ */
.action-button {
	flex-direction: column;
	align-items: center;
}

/* æ“ä½œå›¾æ ‡ */
.action-icon {
	font-size: 40rpx;
	margin-bottom: 10rpx;
}

/* æ“ä½œæ–‡æœ¬ */
.action-text {
	color: #ffffff;
	font-size: 24rpx;
}

/* ç»“æŸç›´æ’­æŒ‰é’® */
.end-live {
	background-color: #ff3b30;
	border-radius: 40rpx;
	padding: 10rpx 30rpx;
}

/* ç¦»å¼€æˆ¿é—´æŒ‰é’® */
.leave-room {
	background-color: #ff9500;
	border-radius: 40rpx;
	padding: 10rpx 30rpx;
}
</style>